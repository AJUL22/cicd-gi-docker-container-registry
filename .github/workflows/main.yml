name: CI - Test, Build & Publish Docker Image

# Run on push to branches and tags, and on pull requests
on:
  push:
    branches: ["**"]
    tags: ["v*","*"]
  pull_request:
    branches: ["**"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write      # required to push to GHCR via GITHUB_TOKEN
  id-token: write

env:
  IMAGE_NAME: demo-app
  # Docker Hub image: <DOCKERHUB_USERNAME>/demo-app
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
  # GHCR image: ghcr.io/<owner>/demo-app
  GHCR_REPO: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
  # tag images by the short commit SHA
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-publish:
    name: Test → Build → Push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'maven'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Run unit tests
        # If tests fail, the job stops here and no docker image is built.
        run: mvn -B -DskipTests=false test

      - name: Package (create jar)
        run: mvn -B -DskipTests package

      - name: Set up QEMU (for multi-platform builds) and Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image to Docker Hub & GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.GHCR_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.GHCR_REPO }}:latest
          # Build args (optional) - not required for this project but left as example
          build-args: |
            MAVEN_OPTS=-Xmx512m

      - name: Image digests (for logging)
        run: |
          echo "Docker Hub image: ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}"
          echo "GHCR image: ${{ env.GHCR_REPO }}:${{ env.IMAGE_TAG }}"

